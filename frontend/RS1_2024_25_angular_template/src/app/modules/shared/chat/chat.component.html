<div class="chat-container">
  <!-- Left panel: conversation list -->
  <div class="conversation-list">
    <div class="header">
      <h3>Razgovori</h3>
      <button (click)="openUserModal()">+ Novi razgovor</button>
    </div>

    <input type="text"
           placeholder="Pretraži"
           class="search-bar"
           [(ngModel)]="searchTerm" />
    <div *ngFor="let convo of filteredConversations"
         class="conversation-item"
         [class.active]="convo.userId === selectedConversation?.userId"
         (click)="selectConversation(convo)">
    <div class="name">{{ convo.fullName }}</div>
      <div class="preview">{{ getLastMessagePreview(convo) }}</div>
      <div class="time">{{ convo.lastMessageTime | date: 'dd. MM. yyyy. HH:mm' }}</div>
    </div>
    <div *ngIf="conversations.length === 0" class="no-conversations">
      Nemate razgovora za prikaz. <br>
      Započnite novi razgovor klikom na dugmić Novi razgovor!
    </div>
  </div>

  <!-- Right panel... -->
  <div class="chat-window">
    <div class="chat-header">
      <div class="name">{{ selectedConversation?.fullName }}</div>
    </div>

    <div class="messages-container">
      <div *ngFor="let group of groupedMessages">
        <div class="date-divider">{{ group.date }}</div>
        <div *ngFor="let msg of group.messages">
          <div class="message" [ngClass]="{ 'mine': msg.senderId === currentUserId }">
            <div class="content">
        <span *ngIf="msg.senderId !== currentUserId" class="sender-name">
          {{ msg.senderFullName }}
        </span>
              <span [innerHTML]="msg.content | linebreaks"></span>
            </div>
            <div class="time">{{ msg.sentAt | date: 'HH:mm' }}</div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedConversation && typingUserId === selectedConversation.userId" class="typing-indicator">
        {{ selectedConversation.fullName }} piše...
      </div>
    </div>

    <div class="chat-input">
      <textarea
        [(ngModel)]="newMessage"
        placeholder="Napiši poruku..."
        rows="2"
        (keydown)="handleKeyDown($event)"
        (input)="onTyping()"
      ></textarea>
      <button (click)="sendMessage()">Pošalji</button>
    </div>
  </div>
</div>

<div *ngIf="showAvailableUsers" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Odaberi korisnika</h3>
      <button class="close-btn" (click)="closeUserModal()">×</button>
    </div>
    <div class="modal-body">
      <div *ngFor="let user of availableUsers"
           class="available-user"
           (click)="startConversationWith(user)">
        {{ user.fullName }} ({{ user.username }})
      </div>
    </div>
  </div>
</div>
